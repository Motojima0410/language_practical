6-4.18

今回の要件は、「注文にステータスを追加する」というものです。
この要件を満たすためにまず、下記の新規テーブルを作成します。


テーブル名：
注文ステータス（order_status）

テーブル構成：

　　カラム　　　  　 　入力する内容

　　status_code　　　　注文ステータスを表すコードを入力します。（例：10、20、30）
　　name　　　　　 　　注文ステータスの名称を入力します。（例：受付済、発注済）



さらに、既存のDBと紐づけるために、order_infoテーブルに下記カラムを追加します。


　　追加する内容　　　　　追加するカラム名　　　　　入力する内容

　　ステータスコード　　　status_code　　　　　　　注文ステータスのコードを入力します。



これにより、注文のステータスが把握できるようになり、残りのタスク管理が容易になります。



SQLの解説

order_statusテーブル
・注文ステータスを格納するテーブルを新たに作成することで正規化を図り、注文ステータスが追加されても他のテーブルには影響がないようにしました。
・status_codeカラムにinteger primary keyを設定し、処理の効率化と表示揺れ防止を図りました。
・加えて、自動裁判ではなく手動採番にし、ステータスコードを10、20、30と間をあけることで、新たにステータスが追加される場合でも管理しやすいようにしました。
・nameカラムにはnot null制約とunique制約を設定し、ステータス名が空欄や重複になることを防ぎました。

status_codeカラム
・order_infoテーブルに数値の外部キーとして設定し、注文全体の現在のステータスをコードで記録するようにしました。
・foreign key制約を設定し、order_statusテーブルに存在しないコードの入力を防ぎました。
・これらにより、データの整合性と拡張性を上げました。



SQL文

order_statusテーブル作成
create table order_status (status_code integer primary key, name varchar(50) not null unique);

status_codeカラム追加
alter table order_info add column status_code integer;

外部キー制約の設定
alter table order_info add constraint fk_status foreign key (status_code) references order_status (status_code);

ステータスデータの投入
insert into order_status (status_code, name) values (10, '受付済'), (20, '発注済'), (30, '在庫確保済'), (40, '処理済');

既存の注文情報にステータスコードを割り当て（仮データとしてすべて受注済に設定）
update order_info set status_code = 10;



実行結果

sql_education=# create table order_status (status_code integer primary key, name varchar(50) not null unique);
CREATE TABLE

sql_education=# alter table order_info add column status_code integer;
ALTER TABLE

sql_education=# alter table order_info add constraint fk_status foreign key (status_code) references order_status (status_code);
ALTER TABLE

sql_education=# insert into order_status (status_code, name) values (10, '受付済'), (20, '発注済'), (30, '在庫確保済'), (40, '処理済');
INSERT 0 4

sql_education=# select * from order_status;
 status_code |    name
-------------+------------
          10 | 受付済
          20 | 発注済
          30 | 在庫確保済
          40 | 処理済
(4 行)

sql_education=# update order_info set status_code = 10;
UPDATE 5

sql_education=# select * from order_info;
 order_info_id | order_date | account_id | is_canceled | store_id | status_code
---------------+------------+------------+-------------+----------+-------------
             1 | 2024-12-30 |          1 | f           |        1 |          10
             2 | 2025-01-20 |          1 | f           |        1 |          10
             3 | 2024-12-31 |          2 | f           |        1 |          10
             4 | 2025-01-20 |          2 | f           |        1 |          10
             5 | 2025-04-01 |          2 | f           |        1 |          10
(5 行)