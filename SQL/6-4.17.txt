6-4.17

今回の要件は、「店舗の概念を追加する」というものです。
この要件を満たすためにまず、下記の新規テーブルを作成します。


テーブル名：
　　店舗テーブル（store）

テーブル構成：

　　カラム名　　　　　入力する内容

　　store_id　　　　　店舗IDを入力します。
　　store_name　　　　店舗名を入力します。
　　address　　　 　　店舗住所を入力します。

さらに、既存のDBと紐づけるために、order_infoテーブルに下記カラムを追加します。


　　追加する内容　　　　　追加するカラム名　　　　入力する内容

　　店舗ID    　　　　　　store_id　     　 　　 商品が注文された店舗のIDを入力します。



これにより、注文された各製品がどの店舗からのものかがわかり、各店舗の販売状況の把握や仕入れの調整などが可能になります。



SQLの解説

storeテーブル
・店舗情報を格納するテーブルを新たに作成することで正規化を図り、店舗情報に変更や追加があってもほかのテーブルには影響のないようにしました。
・store_idをserial primary keyに定義し、店舗IDを自動裁判し重複を防ぎました。
・nameカラムにnot null制約を与え、データの欠損を防ぎました。

order_infoへのstore_id追加
・店舗情報は注文全体にかかわる情報のため、order_itemではなくorder_infoに追加しました。
・存在しない店舗のIDが注文データに記録されることを防ぐために、add constraint句でforeign key制約を設定しました。



SQL文

storeテーブル追加
create table store (store_id serial primary key, name varchar(100) not null, address varchar(255));

store_id追加
alter table order_info add column store_id integer;

外部キー制約の設定
alter table order_info add constraint fk_store foreign key (store_id) references store (store_id);

サンプル店舗データの投入
insert into store (name, address) values ('新宿店', '東京都新宿区'), ('渋谷店', '東京都渋谷区'), ('上野店', '東京都台東区');

既存の注文情報に店舗IDを割り当て（仮データとしてすべて新宿店に設定）
update order_info set store_id = 1;




実行結果

sql_education=# create table store (store_id serial primary key, name varchar(100) not null, address varchar(255));
CREATE TABLE

sql_education=# alter table order_info add column store_id integer;
ALTER TABLE

sql_education=# alter table order_info add constraint fk_store foreign key (store_id) references store (store_id);
ALTER TABLE

sql_education=# insert into store (name, address) values ('新宿店', '東京都新宿区'), ('渋谷店', '東京都渋谷区'), ('上野店', '東京都台東区');
INSERT 0 3

sql_education=# update order_info set store_id = 1;
UPDATE 5

sql_education=# select * from store;
 store_id |  name  |   address
----------+--------+--------------
        1 | 新宿店 | 東京都新宿区
        2 | 渋谷店 | 東京都渋谷区
        3 | 上野店 | 東京都台東区
(3 行)


sql_education=# select * from order_info;
 order_info_id | order_date | account_id | is_canceled | store_id
---------------+------------+------------+-------------+----------
             1 | 2024-12-30 |          1 | f           |        1
             2 | 2025-01-20 |          1 | f           |        1
             3 | 2024-12-31 |          2 | f           |        1
             4 | 2025-01-20 |          2 | f           |        1
             5 | 2025-04-01 |          2 | f           |        1
(5 行)